<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>예약 달력</title>
    <link rel="icon" type="image/svg+xml" href="/bns.svg">
    <link rel="stylesheet" href="/component/header.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600&family=Noto+Sans+KR:wght@400;500;600&display=swap');

        :root {
            --bg: radial-gradient(circle at 10% 20%, #f0f4ff 0, #f8f6ff 30%, #f7fbff 65%, #fdfdfd 100%);
            --card: #ffffff;
            --primary: #4f7cff;
            --accent: #f76b8a;
            --line: #e6e9f3;
            --text-strong: #141927;
            --text: #3a445a;
            --muted: #7d8495;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Noto Sans KR', 'Space Grotesk', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            user-select: none;
        }

        .page {
            max-width: 1180px;
            margin: 28px auto 60px;
            padding: 0 28px 220px;
        }

        .hero {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            align-items: center;
            margin-bottom: 18px;
        }

        .eyebrow {
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            color: var(--muted);
            text-transform: uppercase;
            margin: 0 0 6px;
            font-weight: 600;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 1.8rem;
            color: var(--text-strong);
            font-family: 'Space Grotesk', 'Noto Sans KR', sans-serif;
            letter-spacing: -0.02em;
        }

        .subtext {
            margin: 0;
            color: var(--muted);
        }

        .calendar-shell {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.05);
            padding: 18px;
            user-select: none;
        }

        .range-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 18px 24px;
            border-radius: 14px;
            background: linear-gradient(120deg, rgba(79, 124, 255, 0.16), rgba(247, 107, 138, 0.12));
            border: 1px solid #dfe4ff;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            transform: none;
            width: 100%;
            border-radius: 18px 18px 0 0;
            box-shadow: 0 -6px 24px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            z-index: 60;
            user-select: none;
        }

        .range-chip {
            display: flex;
            flex-direction: row;
            gap: 12px;
            color: var(--text-strong);
            text-align: left;
            align-items: center;
        }

        .range-chip .label {
            font-weight: 700;
            letter-spacing: 0.02em;
            font-size: 0.95rem;
        }

        .range-chip .value {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .range-chip .meta {
            color: var(--muted);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-title {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .calendar-title .month {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-strong);
        }

        .calendar-title .range-label {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .nav-btn {
            border: 1px solid var(--line);
            background: #f8f9ff;
            color: var(--text-strong);
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .nav-btn.ghost {
            background: #fff;
        }

        .range-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
            align-items: center;
        }

        .cta-btn {
            border: none;
            background: var(--primary);
            color: #fff;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(79, 124, 255, 0.3);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .cta-btn:active { transform: translateY(0); }
        .cta-btn:hover { transform: translateY(-1px); }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 8px;
            margin: 12px 0;
            color: var(--muted);
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 8px;
        }

        .day {
            background: #fcfcff;
            border: 1px solid var(--line);
            border-radius: 14px;
            min-height: 200px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            user-select: none;
            touch-action: none;
        }

        .day.empty {
            background: transparent;
            border: none;
        }

        .day-number {
            font-weight: 700;
            color: var(--text-strong);
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 700;
            color: #fff;
        }

        .today-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            display: inline-block;
        }

        .bookings {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }

        .booking {
            padding: 8px 10px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #e8ecf7;
            color: var(--text-strong);
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            text-align: center;
        }

        .booking small {
            color: var(--muted);
            font-weight: 500;
        }

        .more {
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .in-range {
            border-color: rgba(79, 124, 255, 0.45);
            box-shadow: inset 0 0 0 2px rgba(79, 124, 255, 0.12);
            background: #f5f7ff;
        }

        .selecting {
            border-style: dashed;
            border-color: rgba(79, 124, 255, 0.65);
            background: rgba(79, 124, 255, 0.07);
        }

        .start-only {
            border-color: rgba(79, 124, 255, 0.75);
            background: rgba(79, 124, 255, 0.1);
            box-shadow: inset 0 0 0 2px rgba(79, 124, 255, 0.14);
        }

        .legend {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin: 14px 0 6px;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 6, 22, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 120;
        }

        .modal.open { display: flex; }

        .modal-card {
            background: #fff;
            border-radius: 16px;
            max-width: 460px;
            width: min(92vw, 460px);
            padding: 18px 18px 14px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.12);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: var(--text-strong);
            font-weight: 700;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .empty-state {
            color: var(--muted);
            font-weight: 600;
            padding: 16px 0 8px;
        }

        @media (max-width: 900px) {
            .hero { grid-template-columns: 1fr; }
            .calendar-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .weekdays { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .day { min-height: 120px; }
        }

        @media (max-width: 640px) {
            body { font-size: 16px; }
            .page { padding: 0 16px 180px; }
            h1 { font-size: 1.45rem; }
            .calendar-shell { padding: 14px; }
            .calendar-header { flex-direction: column; gap: 8px; align-items: flex-start; }
            .calendar-title .month { font-size: 1.15rem; }
            .weekdays { grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 4px; }
            .calendar-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 10px; }
            .day { min-height: 120px; padding: 14px; }
            .booking { font-size: 0.95rem; }
            .range-banner {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <div class="hero">
        <div>
            <p class="eyebrow">예약 현황</p>
            <h1>월간 캘린더로 한눈에 보기</h1>
            <p class="subtext">구글 캘린더처럼 넉넉한 칸에 예약자 이름이 채워집니다. 원하는 날짜를 탭하거나 드래그하면 상단 배지에서 기간이 크게 표시돼요.</p>
        </div>
    </div>

    <div class="calendar-shell">
        <div class="calendar-header">
            <button class="nav-btn" id="prev-month">◀ 지난 달</button>
            <div class="calendar-title">
                <span class="month" id="month-label"></span>
            </div>
            <button class="nav-btn" id="next-month">다음 달 ▶</button>
        </div>

        <div class="range-banner">
            <div class="range-chip">
                <span class="value" id="range-display">선택 없음</span>
                <span class="meta" id="range-meta">날짜를 탭하거나 드래그해 선택하세요</span>
            </div>
            <div class="range-actions">
                <button class="nav-btn ghost" id="reset-today">초기화</button>
                <button class="cta-btn" id="book-btn">예약하기</button>
            </div>
        </div>

        <div class="legend">
            <span class="legend-item"><span class="today-dot"></span> 오늘</span>
            <span class="legend-item"><span class="badge" style="background:#4f7cff;">예약</span> 예약자 이름</span>
            <span class="legend-item">파란 테두리: 선택한 여행 기간</span>
        </div>

        <div class="weekdays">
            <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>
</div>
<script type="module" src="/component/header.js"></script>
<script>
    const bookings = [
        { guest: '김민수', start: '2025-12-02', end: '2025-12-04' },
        { guest: '박지현', start: '2025-12-07', end: '2025-12-09' },
        { guest: '홍은지', start: '2025-12-07', end: '2025-12-07' },
        { guest: '이재훈', start: '2025-12-11', end: '2025-12-14' },
        { guest: '최서윤', start: '2025-12-15', end: '2025-12-18' },
        { guest: '이가영', start: '2025-12-20', end: '2025-12-22' },
        { guest: '강태오', start: '2025-12-22', end: '2025-12-24' },
        { guest: '오하늘', start: '2025-12-27', end: '2025-12-30' },
        { guest: '정윤아', start: '2025-12-30', end: '2025-12-30' }
    ];

    const monthLabel = document.getElementById('month-label');
    const rangeDisplay = document.getElementById('range-display');
    const rangeMeta = document.getElementById('range-meta');
    const resetTodayBtn = document.getElementById('reset-today');
    const calendarGrid = document.getElementById('calendar-grid');
    const prevBtn = document.getElementById('prev-month');
    const nextBtn = document.getElementById('next-month');
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-card">
            <div class="modal-header">
                <span id="modal-title"></span>
                <button class="modal-close" id="modal-close" aria-label="닫기">✕</button>
            </div>
            <div id="modal-body"></div>
        </div>
    `;
    document.body.appendChild(modal);
    const modalTitle = modal.querySelector('#modal-title');
    const modalBody = modal.querySelector('#modal-body');
    const modalClose = modal.querySelector('#modal-close');

    const today = new Date();
    let currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    let selectedStart = null;
    let selectedEnd = null;
    let dragStartDate = null;
    let dragging = false;
    let longPressTimer = null;
    let longPressTriggered = false;
    let awaitingEnd = false;
    let lastHoverDate = null;

    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function parseDate(value) {
        const [y, m, d] = value.split('-').map(Number);
        return new Date(y, m - 1, d);
    }

    function dayDiff(startStr, endStr) {
        return Math.round((parseDate(endStr) - parseDate(startStr)) / (1000 * 60 * 60 * 24));
    }

    function updateRangeDisplay() {
        if (!selectedStart && !selectedEnd) {
            rangeDisplay.textContent = '선택 없음';
            rangeMeta.textContent = '날짜를 탭하거나 드래그해 선택하세요';
            return;
        }

        rangeDisplay.textContent = `${selectedStart} ~ ${selectedEnd}`;

        const diff = dayDiff(selectedStart, selectedEnd);
        if (diff === 0) {
            rangeMeta.textContent = '당일 예약';
        } else {
            rangeMeta.textContent = `${diff}박 · ${diff + 1}일`;
        }
    }

    function isSameDay(a, b) {
        return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    function isWithin(date, start, end) {
        const target = typeof date === 'string' ? parseDate(date) : date;
        if (!start || !end) return false;
        return target >= parseDate(start) && target <= parseDate(end);
    }

    function buildDayCell(dayNum, monthDate) {
        const dayContainer = document.createElement('div');
        dayContainer.className = 'day';

        const date = new Date(monthDate.getFullYear(), monthDate.getMonth(), dayNum);
        const dateStr = formatDate(date);
        dayContainer.dataset.date = dateStr;
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dayNum;

        if (isSameDay(date, today)) {
            const dot = document.createElement('span');
            dot.className = 'today-dot';
            dayNumber.appendChild(dot);
        }

        if (selectedStart && selectedEnd && isWithin(date, selectedStart, selectedEnd)) {
            dayContainer.classList.add('in-range');
        } else if (selectedStart && !selectedEnd && isSameDay(date, parseDate(selectedStart))) {
            dayContainer.classList.add('start-only');
        }

        const todaysBookings = bookings.filter(b => isWithin(date, b.start, b.end));
        const bookingsArea = document.createElement('div');
        bookingsArea.className = 'bookings';

        todaysBookings.slice(0, 3).forEach(item => {
            const booking = document.createElement('div');
            booking.className = 'booking';

            const guest = document.createElement('span');
            guest.textContent = item.guest;

            booking.appendChild(guest);
            bookingsArea.appendChild(booking);
        });

        if (todaysBookings.length > 3) {
            const more = document.createElement('div');
            more.className = 'more';
            more.textContent = `+${todaysBookings.length - 3}명 더`;
            bookingsArea.appendChild(more);
        }

        dayContainer.appendChild(dayNumber);
        dayContainer.appendChild(bookingsArea);
        return dayContainer;
    }

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const offset = firstDay.getDay();
        const totalCells = offset + lastDay.getDate();

        monthLabel.textContent = `${year}년 ${month + 1}월`;
        updateRangeDisplay();

        calendarGrid.innerHTML = '';

        for (let i = 0; i < offset; i++) {
            const empty = document.createElement('div');
            empty.className = 'day empty';
            calendarGrid.appendChild(empty);
        }

        for (let day = 1; day <= lastDay.getDate(); day++) {
            calendarGrid.appendChild(buildDayCell(day, currentMonth));
        }

        calendarGrid.querySelectorAll('.day').forEach(cell => {
            if (cell.classList.contains('empty')) return;
            cell.addEventListener('pointerdown', onDayPointerDown);
            cell.addEventListener('pointerenter', onDayPointerEnter);
            cell.addEventListener('pointermove', onDayPointerMove);
            cell.addEventListener('pointerup', onDayPointerUp);
            cell.addEventListener('click', onDayClick);
            cell.addEventListener('pointerleave', cancelLongPress);
            cell.addEventListener('pointercancel', cancelLongPress);
        });
    }

    prevBtn.addEventListener('click', () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
        renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        renderCalendar();
    });

    resetTodayBtn.addEventListener('click', () => {
        currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        selectedStart = null;
        selectedEnd = null;
        awaitingEnd = false;
        renderCalendar();
    });

    function getBookingsByDate(dateStr) {
        return bookings.filter(b => isWithin(dateStr, b.start, b.end));
    }

    function clearSelecting() {
        calendarGrid.querySelectorAll('.selecting').forEach(el => el.classList.remove('selecting'));
    }

    function startLongPress(dateStr) {
        cancelLongPress();
        longPressTimer = setTimeout(() => {
            longPressTriggered = true;
            dragStartDate = null;
            dragging = false;
            clearSelecting();
            showModal(dateStr);
        }, 650);
    }

    function cancelLongPress() {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }

    function onDayPointerDown(e) {
        e.preventDefault();
        const dateStr = e.currentTarget.dataset.date;
        dragStartDate = dateStr;
        lastHoverDate = dateStr;
        dragging = false;
        longPressTriggered = false;
        clearSelecting();
        e.currentTarget.classList.add('selecting');
        startLongPress(dateStr);
    }

    function onDayPointerEnter(e) {
        if (!dragStartDate) return;
        const dateStr = e.currentTarget.dataset.date;
        lastHoverDate = dateStr;
        if (dateStr !== dragStartDate) {
            cancelLongPress();
            dragging = true;
            previewSelection(dragStartDate, dateStr);
        }
    }

    function onDayPointerMove(e) {
        if (!dragStartDate) return;
        const target = e.currentTarget;
        if (!target || !target.dataset) return;
        lastHoverDate = target.dataset.date;
        if (lastHoverDate !== dragStartDate) {
            cancelLongPress();
            dragging = true;
            previewSelection(dragStartDate, target.dataset.date);
        }
    }

    function onDayPointerUp(e) {
        finalizePointer(e.currentTarget.dataset.date);
    }

    function onDayClick(e) {
        if (dragging || longPressTriggered) return;
        cancelLongPress();
        handleSingleClick(e.currentTarget.dataset.date);
        dragStartDate = null;
        lastHoverDate = null;
    }

    function previewSelection(startStr, endStr) {
        clearSelecting();
        const start = parseDate(startStr);
        const end = parseDate(endStr);
        const [from, to] = start <= end ? [start, end] : [end, start];
        calendarGrid.querySelectorAll('.day:not(.empty)').forEach(cell => {
            const cellDate = parseDate(cell.dataset.date);
            if (cellDate >= from && cellDate <= to) cell.classList.add('selecting');
        });
    }

    function applyDraggedRange(startStr, endStr) {
        const start = parseDate(startStr);
        const end = parseDate(endStr);
        const [from, to] = start <= end ? [start, end] : [end, start];
        selectedStart = formatDate(from);
        selectedEnd = formatDate(to);
        awaitingEnd = false;
        renderCalendar();
    }

    function finalizePointer(dateStr) {
        cancelLongPress();
        const targetDate = lastHoverDate || dateStr || dragStartDate;
        if (longPressTriggered) {
            dragStartDate = null;
            dragging = false;
            longPressTriggered = false;
            clearSelecting();
            lastHoverDate = null;
            return;
        }
        if (dragStartDate && dragging && targetDate) {
            applyDraggedRange(dragStartDate, targetDate);
        } else if (targetDate) {
            handleSingleClick(targetDate);
        }
        dragStartDate = null;
        dragging = false;
        clearSelecting();
        lastHoverDate = null;
    }

    function handleSingleClick(dateStr) {
        selectedStart = dateStr;
        selectedEnd = dateStr;
        awaitingEnd = false;
        renderCalendar();
    }

    function showModal(dateStr) {
        const list = getBookingsByDate(dateStr);
        modalTitle.textContent = `${dateStr} 예약`;
        modalBody.innerHTML = '';
        if (!list.length) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = '예약이 없습니다.';
            modalBody.appendChild(empty);
        } else {
            list.forEach(item => {
                const row = document.createElement('div');
                row.className = 'booking';
                const guest = document.createElement('span');
                guest.textContent = item.guest;
                const range = document.createElement('small');
                range.textContent = `${item.start} ~ ${item.end}`;
                row.appendChild(guest);
                row.appendChild(range);
                modalBody.appendChild(row);
            });
        }
        modal.classList.add('open');
    }

    modalClose.addEventListener('click', () => modal.classList.remove('open'));
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('open');
    });

    window.addEventListener('pointermove', (e) => {
        if (!dragStartDate) return;
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const cell = el ? el.closest('.day:not(.empty)') : null;
        if (cell && cell.dataset.date) {
            lastHoverDate = cell.dataset.date;
            if (lastHoverDate !== dragStartDate) {
                cancelLongPress();
                dragging = true;
                previewSelection(dragStartDate, cell.dataset.date);
            }
        }
    }, { passive: false });

    window.addEventListener('pointerup', (e) => {
        if (!dragStartDate) return;
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const cell = el ? el.closest('.day:not(.empty)') : null;
        finalizePointer(cell?.dataset?.date);
    }, { passive: false });

    window.addEventListener('pointercancel', () => {
        if (dragStartDate) {
            finalizePointer(null);
        }
    });

    renderCalendar();
</script>
</body>
</html>
